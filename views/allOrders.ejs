<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - Kobe Land</title>
   
    <style>
        :root {
          /* ===== Colors ===== */
          --gray-50:   #F8F9FA;
          --gray-200:  #E5E7EB;
          --gray-800:  #2D3748;
          --primary:   #0071E3;
          --primary-2: #005bb5;
          --white:     #FFFFFF;
        
          /* ===== Spacing Scale ===== */
          --space-1: 0.25rem;   /* 4px */
          --space-2: 0.5rem;    /* 8px */
          --space-3: 1rem;      /* 16px */
          --space-4: 1.5rem;    /* 24px */
          --space-5: 2rem;      /* 32px */
          --space-6: 3rem;      /* 48px */
        
          /* ===== Radius & Fonts ===== */
          --radius-sm: 0.375rem; /* 6px */
          --radius:    0.5rem;   /* 8px */
          --radius-lg: 1rem;     /* 16px */
          --fs-sm: 0.875rem;     /* 14px */
          --fs-md: 1rem;         /* 16px */
          --fs-lg: 1.25rem;      /* 20px */
          --fs-xl: 1.875rem;     /* 30px */
        }
        
        /* ===== Base ===== */
        * {
          box-sizing: border-box;
        }
        body {
          margin: 0;
          padding: 0;
          background: var(--gray-50);
          font-family: sans-serif;
          font-size: var(--fs-md);
          line-height: 1.5;
          direction: rtl;
        }
        
        /* ===== Container ===== */
        .container {
          max-width: 1140px;
          margin: 0 auto;
          padding: var(--space-5) var(--space-4);
        }
        
        /* ===== Typography ===== */
        .text-3xl {
          font-size: var(--fs-xl);
          margin-bottom: var(--space-3);
        }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: var(--gray-800); }
        
        /* ===== Layout Helpers ===== */
        .mb-8 { margin-bottom: var(--space-5); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-3 { margin-top: var(--space-3); }
        .p-6  { padding: var(--space-6); }
        .p-4  { padding: var(--space-4); }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .gap-4 { gap: var(--space-4); }
        .gap-3 { gap: var(--space-3); }
        
        /* ===== Inputs & Selects ===== */
        .input,
        .select {
          width: 100%;
          padding: var(--space-2) var(--space-3);
          margin-bottom: var(--space-3);
          font-size: var(--fs-md);
          border: 1px solid var(--gray-200);
          border-radius: var(--radius);
          background: var(--white);
        }
        
        /* ===== تخصيص حقل البحث وزر الحالة ===== */
        #search {
          flex: 2;
          font-size: var(--fs-lg);
          padding: var(--space-3) var(--space-4);
        }
        #statusFilter {
          flex: none;
          width: 8rem;
          font-size: var(--fs-sm);
          padding: var(--space-2) var(--space-3);
        }
        
        /* ===== Buttons ===== */
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-2) var(--space-4);
          border: 1px solid transparent;
          border-radius: var(--radius-sm);
          font-size: var(--fs-md);
          cursor: pointer;
          transition: background 0.2s, border-color 0.2s;
        }
        .btn:hover { background: var(--gray-50); }
        .btn-sm  { font-size: var(--fs-sm); padding: var(--space-1) var(--space-3); }
        .btn-primary {
          background: var(--primary);
          color: var(--white);
          border-color: var(--primary);
        }
        .btn-primary:hover { background: var(--primary-2); }
        .btn-ghost { background: transparent; color: var(--gray-800); }
        .btn-active { background: var(--gray-200); }
        
        /* ===== Table ===== */
        .overflow-x-auto { overflow-x: auto; }
        .table {
          width: 100%;
          border-collapse: collapse;
          background: var(--white);
        }
        .table th,
        .table td {
          padding: var(--space-3) var(--space-4);
          border-bottom: 1px solid var(--gray-200);
          font-size: var(--fs-md);
        }
        .table thead tr { background: var(--gray-50); }
        
        /* ===== Card ===== */
        .dashboard-card {
          background: var(--white);
          border-radius: var(--radius-lg);
          box-shadow: 0 10px 30px rgba(0,0,0,0.05);
          transition: transform 0.3s ease;
          margin-bottom: var(--space-6);
        }
        
        /* ===== Pagination ===== */
        .join {
          display: inline-flex;
          border-radius: var(--radius-sm);
          overflow: hidden;
        }
        .join-item {
          padding: var(--space-2) var(--space-3);
          border-right: 1px solid var(--gray-200);
          margin: 10px;
        }
        .join-item:last-child { border-right: none; }
        
        /* ===== تخصيص مودال التفاصيل ===== */
        dialog.modal {
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.5);
  padding: 0;
  border: none;
  width: 100vw;
  height: 100vh;
  max-width: none;
}

.modal-box {
  width: 96vw;
  height: 92vh;
  max-width: 1400px;
  max-height: 92vh;
  display: flex;
  flex-direction: column;
  border-radius: var(--radius-lg);
  padding: var(--space-5);
  background: var(--white);
  overflow: hidden;
}


.modal-box h3 {
  font-size: var(--fs-xl);
  border-bottom: 2px solid var(--gray-200);
  padding-bottom: var(--space-3);
  margin-bottom: var(--space-4);
}

#orderDetails {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-6);
  flex-grow: 1;
  overflow: auto;
  padding: var(--space-3);
}

/* القسم الأيسر - معلومات العميل */
.order-info-section {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-3);
  align-content: start;
}

.order-info-section h4 {
  font-weight: 600;
  color: var(--primary);
  grid-column: span 2;
  margin-top: var(--space-3);
}

.order-info-section p {
  background: var(--gray-50);
  padding: var(--space-2);
  border-radius: var(--radius-sm);
  margin: 0;
}

/* قسم تحديث الحالة */
.status-update-section {
  grid-column: span 2;
  border-top: 2px solid var(--gray-200);
  padding-top: var(--space-4);
}

/* قسم الصور */
.images-section {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.images-container {
  flex-grow: 1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: var(--space-3);
  overflow-y: auto;
  padding: var(--space-2);
}

.images-container img {
  width: 100%;
  height: 180px;
  object-fit: contain;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  background: white;
  padding: var(--space-1);
}


        
        /* ===== زر التحديث والإغلاق ===== */
        .modal-action .btn {
          padding: var(--space-2) var(--space-4);
          font-size: var(--fs-md);
        }
        
        /* ===== Badges ===== */
        .order-status {
  padding: 0.25rem 0.75rem;  /* أقل من السابق */
  font-size: 0.875rem;       /* حجم خط أصغر */
  white-space: nowrap;       /* اجعل النص في سطر واحد */
  display: inline-block;  
  font-size: var(--fs-sm);
  border-radius: 9999px;   
  line-height: 1;            /* لضبط ارتفاع السطر */
}
        .status-pending     { background: #E3F2FD; color: #1976D2; }
        .status-in_progress { background: #FFF3E0; color: #EF6C00; }
        .status-completed   { background: #E8F5E9; color: #2E7D32; }

        /* تنسيقات الفورم */
.form-control .label {
    font-size: var(--fs-sm);
    color: var(--gray-800);
    padding: var(--space-1) 0;
}

.textarea {
    resize: vertical;
    min-height: 100px;
    width: 100%;
    padding: var(--space-2);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
}

/* تنسيق عنصر السيليكت */
#package_size {
  width: 100%;
  padding: var(--space-2) var(--space-3);
  font-size: var(--fs-md);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  background: var(--white);
  cursor: pointer;
  transition: all 0.2s ease;
  appearance: none; /* إزالة المظهر الافتراضي */
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232D3748' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 1.2em;
}

/* تأثيرات الهاڤر والفوكوس */
#package_size:hover {
  border-color: var(--primary);
}

#package_size:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
}

/* تنسيق الخيارات */
#package_size option {
  padding: var(--space-2);
  background: var(--white);
}

/* تحسينات للعرض على الأجهزة المحمولة */
@media (max-width: 768px) {
  #package_size {
    font-size: var(--fs-sm);
  }
}
        </style>
        
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">إدارة الطلبات</h1>
            <div class="flex gap-4 mt-4">
                <div class="flex-1">
                    <input type="text" id="search" placeholder="ابحث بالاسم أو رقم الهاتف..." 
                           class="w-full input input-bordered">
                </div>
                <select id="statusFilter" class="select select-bordered">
                    <option value="">جميع الحالات</option>
                    <option value="pending">قيد الانتظار</option>
                    <option value="in_progress">قيد التنفيذ</option>
                    <option value="completed">مكتمل</option>
                </select>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="dashboard-card overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-right">رقم الطلب</th>
                            <th class="text-right">العميل</th>
                            <th class="text-right">رقم الهاتف</th>
                            <th class="text-right">المحافظة</th>
                            <th class="text-right">المنطقة</th>
                            <th class="text-right">الحالة</th>
                            <th class="text-right">إرسال الى الوسيط</th>
                            <th class="text-right">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-center p-4 bg-gray-50">
                <div class="join" id="pagination">
                    <!-- Dynamic pagination buttons -->
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <dialog id="orderModal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl">
            <h3 class="font-bold text-lg">تفاصيل الطلب</h3>
            <div class="py-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="orderDetails">
                <!-- Dynamic content -->
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">إغلاق</button>
                </form>
            </div>
        </div>
    </dialog>

    
<!-- Send Form Modal -->
<dialog id="sendModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg">إرسال الطلب إلى الوسيط</h3>
        <form action="/orders/sendToWaseet" method="post" id="sendForm" class="py-4">
            <input type="hidden" name="orderid" id="sendOrderId">
            
            <div class="grid grid-cols-1 gap-3">
                <div class="form-control">
                    <label class="label">* عدد المواد</label>
                    <input name="items_number" type="text" class="input input-bordered" required>
                </div>
                
                <div class="form-control">
                    <label class="label">السعر مع التوصيل *</label>
                    <input name="price" type="tel" class="input input-bordered" required>
                </div>
                
                <div class="form-control">
                    <label class="label">حجم الطلبية</label>
                    <select name="package_size" id="package_size">
                        <option value="1">عادي</option>
                        <option value="2">متوسط</option>
                        <option value="3">كبير</option>
                        <option value="4">كبير جداً</option>
                    </select>                
                </div>
            </div>
            
            <div class="modal-action">
                <button type="button" onclick="document.getElementById('sendModal').close()" 
                        class="btn btn-ghost">إلغاء</button>
                <button type="submit" class="btn btn-primary">إرسال</button>
            </div>
        </form>
    </div>
</dialog>

    <script>

      
        let currentPage = 1;
    const itemsPerPage = 10;
    const cityMap   = {};  // id → name
    const regionMap = {};  // id → name

    // 1) حمّل خريطة المحافظات مرة واحدة
    async function loadCitiesMap() {
      const res = await fetch('/api/cities');
      const json = await res.json();
      if (json.status) {
        json.data.forEach(c => cityMap[c.id] = c.city_name);
      }
    }

    // 2) حمّل خريطة المناطق لأي مجموعة من المحافظات
    async function loadRegionsMapFor(cityIds) {
      const ids = [...new Set(cityIds)];
      await Promise.all(ids.map(async id => {
        if (!regionMap[id]) {
          const res = await fetch(`/api/regions?city_id=${id}`);
          const json = await res.json();
          if (json.status) {
            json.data.forEach(r => regionMap[r.id] = r.region_name);
          }
        }
      }));
    }

    // 3) جلب الطلبات مع التأكد من الخرائط
    async function loadOrders(page = 1, search = '', status = '') {
      if (!Object.keys(cityMap).length) {
        await loadCitiesMap();
      }
      const res = await fetch(
        `/orders?page=${page}&limit=${itemsPerPage}&search=${search}&orderStatus=${status}`,
        { headers: { 'Accept': 'application/json' } }
      );
      const data = await res.json();
      const cityIds = data.items.map(o => o.city);
      await loadRegionsMapFor(cityIds);
      renderOrders(data.items);
      renderPagination(data.totalPages, page);
      currentPage = page;
    }

    // 4) عرض الطلبات بالأسماء
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersBody');
      tbody.innerHTML = orders.map(o => `
        <tr>
          <td>#${o.id}</td>
          <td>${o.name}</td>
          <td>${o.mobile}</td>
          <td>${cityMap[o.city] || '—'}</td>
          <td>${regionMap[o.region] || '—'}</td>
         
          <td>
            <span class="order-status status-${o.orderStatus}">
              ${getStatusText(o.orderStatus)}
            </span>
          </td>
           <td>
            <button onclick="showSendForm(${o.id})" class="btn btn-ghost btn-sm">
    إرسال
</button>
          </td>
          <td>
            <button onclick="showOrderDetails(${o.id})" class="btn btn-ghost btn-sm">
              التفاصيل
            </button>
          </td>
        </tr>
      `).join('');
    }

    function renderPagination(total, current) {
      const p = document.getElementById('pagination');
      p.innerHTML = Array.from({ length: total }, (_, i) => `
        <button class="join-item btn ${i+1===current?'btn-active':''}"
                onclick="loadOrders(${i+1})">${i+1}</button>
      `).join('');
    }
  

      async function showOrderDetails(orderId) {
  try {
    const response = await fetch(`/orders/${orderId}`);
    const order = await response.json();

    // تحويل الصور كما في السابق
    const imagesHTML = order.images.map(img => {
      const isEncoded = /%[0-9A-Fa-f]{2}/.test(img);
      let finalSrc = isEncoded ? decodeURIComponent(img) : encodeURI(img);
      finalSrc = finalSrc.replace(/%25([0-9A-Fa-f]{2})/g, '%$1');
      return `
        <div class="image-item">
          <img src="${finalSrc}" 
               alt="صورة الطلب"
               onerror="this.src='/placeholder-image.png'">
        </div>
      `;
    }).join('');

    // هنا نستخدم الخرائط لعرض الأسماء
    const cityName   = cityMap[order.city]   || '—';
    const regionName = regionMap[order.region] || '—';

    document.getElementById('orderDetails').innerHTML = `
      <div class="order-info-section">
        <h4>معلومات العميل</h4>
        <div class="info-group">
          <label>الاسم الكامل:</label>
          <p>${order.name}</p>
        </div>
        <div class="info-group">
          <label>رقم الجوال:</label>
          <p>${order.mobile}</p>
        </div>
        <div class="info-group">
          <label>المحافظة:</label>
          <p>${cityName}</p>
        </div>
        <div class="info-group">
          <label>المنطقة:</label>
          <p>${regionName}</p>
        </div>
        <div class="info-group">
          <label>النقطة الدالة:</label>
          <p>${order.nearestPoint}</p>
        </div>
        <div class="info-group">
          <label>ملاحظات:</label>
          <p>${order.note || 'لا توجد ملاحظات'}</p>
        </div>
        
        <div class="status-update-section">
          <h4>حالة الطلب</h4>
          <div class="current-status">
            <span class="order-status status-${order.orderStatus}">
              ${getStatusText(order.orderStatus)}
            </span>
          </div>
          <div class="update-form mt-4">
            <select id="statusUpdate" class="input">
              <option value="pending" ${order.orderStatus === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
              <option value="in_progress" ${order.orderStatus === 'in_progress' ? 'selected' : ''}>قيد التنفيذ</option>
              <option value="completed" ${order.orderStatus === 'completed' ? 'selected' : ''}>مكتمل</option>
            </select>
            <button onclick="updateStatus(${order.id})" class="btn btn-primary mt-3">
              تحديث الحالة
            </button>
          </div>
        </div>
      </div>

      <div class="images-section">
        <h4>الصور المرفوعة (${order.images.length})</h4>
        <div class="images-container">
          ${imagesHTML}
        </div>
      </div>
    `;

    document.getElementById('orderModal').showModal();
  } catch (error) {
    console.error('Error fetching order details:', error);
  }
}


  async function showOrderDetails(orderId) {
  try {
    const response = await fetch(`/orders/${orderId}`);
    const order = await response.json();

    // تحويل الصور كما في السابق
    const imagesHTML = order.images.map(img => {
      const isEncoded = /%[0-9A-Fa-f]{2}/.test(img);
      let finalSrc = isEncoded ? decodeURIComponent(img) : encodeURI(img);
      finalSrc = finalSrc.replace(/%25([0-9A-Fa-f]{2})/g, '%$1');
      return `
        <div class="image-item">
          <img src="${finalSrc}" 
               alt="صورة الطلب"
               onerror="this.src='/placeholder-image.png'">
        </div>
      `;
    }).join('');

    // هنا نستخدم الخرائط لعرض الأسماء
    const cityName   = cityMap[order.city]   || '—';
    const regionName = regionMap[order.region] || '—';

    document.getElementById('orderDetails').innerHTML = `
      <div class="order-info-section">
        <h4>معلومات العميل</h4>
        <div class="info-group">
          <label>الاسم الكامل:</label>
          <p>${order.name}</p>
        </div>
        <div class="info-group">
          <label>رقم الجوال:</label>
          <p>${order.mobile}</p>
        </div>
        <div class="info-group">
          <label>المحافظة:</label>
          <p>${cityName}</p>
        </div>
        <div class="info-group">
          <label>المنطقة:</label>
          <p>${regionName}</p>
        </div>
        <div class="info-group">
          <label>النقطة الدالة:</label>
          <p>${order.nearestPoint}</p>
        </div>
        <div class="info-group">
          <label>ملاحظات:</label>
          <p>${order.note || 'لا توجد ملاحظات'}</p>
        </div>
        
        <div class="status-update-section">
          <h4>حالة الطلب</h4>
          <div class="current-status">
            <span class="order-status status-${order.orderStatus}">
              ${getStatusText(order.orderStatus)}
            </span>
          </div>
          <div class="update-form mt-4">
            <select id="statusUpdate" class="input">
              <option value="pending" ${order.orderStatus === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
              <option value="in_progress" ${order.orderStatus === 'in_progress' ? 'selected' : ''}>قيد التنفيذ</option>
              <option value="completed" ${order.orderStatus === 'completed' ? 'selected' : ''}>مكتمل</option>
            </select>
            <button onclick="updateStatus(${order.id})" class="btn btn-primary mt-3">
              تحديث الحالة
            </button>
          </div>
        </div>
      </div>

      <div class="images-section">
        <h4>الصور المرفوعة (${order.images.length})</h4>
        <div class="images-container">
          ${imagesHTML}
        </div>
      </div>
    `;

    document.getElementById('orderModal').showModal();
  } catch (error) {
    console.error('Error fetching order details:', error);
  }
}
        // Update order status
        async function updateStatus(orderId) {
            const newStatus = document.getElementById('statusUpdate').value;
            
            try {
                const response = await fetch(`/orders/orderstatus/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderStatus: newStatus })
                });

                if (response.ok) {
                    loadOrders(currentPage);
                    document.getElementById('orderModal').close();
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                pending: 'قيد الانتظار',
                in_progress: 'قيد التنفيذ',
                completed: 'مكتمل'
            };
            return statusMap[status] || 'غير معروف';
        }

        // Event Listeners
        document.getElementById('search').addEventListener('input', (e) => {
            loadOrders(1, e.target.value, document.getElementById('statusFilter').value);
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            loadOrders(1, document.getElementById('search').value, e.target.value);
        });

          // Event listeners
    document.getElementById('search').addEventListener('input', e =>
      loadOrders(1, e.target.value, document.getElementById('statusFilter').value)
    );
    document.getElementById('statusFilter').addEventListener('change', e =>
      loadOrders(1, document.getElementById('search').value, e.target.value)
    );
    

    // عرض فورم الإرسال
function showSendForm(orderId) {
    document.getElementById('sendOrderId').value = orderId;
    document.getElementById('sendModal').showModal();
}

document.getElementById('sendForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري الإرسال...';
        
        // إنشاء FormData من النموذج
        const formData = new FormData(form);
        
        // تحويل FormData إلى كائن JSON
        const formDataObj = {};
        formData.forEach((value, key) => formDataObj[key] = value);
        
        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // تحديد أننا نرسل JSON
            },
            body: JSON.stringify(formDataObj) // تحويل البيانات إلى JSON
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message || 'تم الإرسال بنجاح');
            document.getElementById('sendModal').close();
            form.reset();
        } else {
            throw new Error(result.message || 'فشل في الإرسال');
        }
    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'حدث خطأ أثناء الإرسال');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'إرسال';
    }
});

        // Initial Load
        loadOrders();

    </script>
</body>
</html>