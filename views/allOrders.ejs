<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - Kobe Land</title>
   
    <style>
        :root {
          /* ===== Colors ===== */
          --gray-50:   #F8F9FA;
          --gray-200:  #E5E7EB;
          --gray-800:  #2D3748;
          --primary:   #0071E3;
          --primary-2: #005bb5;
          --white:     #FFFFFF;
        
          /* ===== Spacing Scale ===== */
          --space-1: 0.25rem;   /* 4px */
          --space-2: 0.5rem;    /* 8px */
          --space-3: 1rem;      /* 16px */
          --space-4: 1.5rem;    /* 24px */
          --space-5: 2rem;      /* 32px */
          --space-6: 3rem;      /* 48px */
        
          /* ===== Radius & Fonts ===== */
          --radius-sm: 0.375rem; /* 6px */
          --radius:    0.5rem;   /* 8px */
          --radius-lg: 1rem;     /* 16px */
          --fs-sm: 0.875rem;     /* 14px */
          --fs-md: 1rem;         /* 16px */
          --fs-lg: 1.25rem;      /* 20px */
          --fs-xl: 1.875rem;     /* 30px */
        }
        
        /* ===== Base ===== */
        * {
          box-sizing: border-box;
        }
        body {
          margin: 0;
          padding: 0;
          background: var(--gray-50);
          font-family: sans-serif;
          font-size: var(--fs-md);
          line-height: 1.5;
          direction: rtl;
        }
        
        /* ===== Container ===== */
        .container {
          max-width: 1140px;
          margin: 0 auto;
          padding: var(--space-5) var(--space-4);
        }
        
        /* ===== Typography ===== */
        .text-3xl {
          font-size: var(--fs-xl);
          margin-bottom: var(--space-3);
        }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: var(--gray-800); }
        
        /* ===== Layout Helpers ===== */
        .mb-8 { margin-bottom: var(--space-5); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-3 { margin-top: var(--space-3); }
        .p-6  { padding: var(--space-6); }
        .p-4  { padding: var(--space-4); }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .gap-4 { gap: var(--space-4); }
        .gap-3 { gap: var(--space-3); }
        
        /* ===== Inputs & Selects ===== */
        .input,
        .select {
          width: 100%;
          padding: var(--space-2) var(--space-3);
          margin-bottom: var(--space-3);
          font-size: var(--fs-md);
          border: 1px solid var(--gray-200);
          border-radius: var(--radius);
          background: var(--white);
        }
        
        /* ===== تخصيص حقل البحث وزر الحالة ===== */
        #search {
          flex: 2;
          font-size: var(--fs-lg);
          padding: var(--space-3) var(--space-4);
        }
        #statusFilter {
          flex: none;
          width: 8rem;
          font-size: var(--fs-sm);
          padding: var(--space-2) var(--space-3);
        }
        
        /* ===== Buttons ===== */
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-2) var(--space-4);
          border: 1px solid transparent;
          border-radius: var(--radius-sm);
          font-size: var(--fs-md);
          cursor: pointer;
          transition: background 0.2s, border-color 0.2s;
        }
        .btn:hover { background: var(--gray-50); }
        .btn-sm  { font-size: var(--fs-sm); padding: var(--space-1) var(--space-3); }
        .btn-primary {
          background: var(--primary);
          color: var(--white);
          border-color: var(--primary);
        }
        .btn-primary:hover { background: var(--primary-2); }
        .btn-ghost { background: transparent; color: var(--gray-800); }
        .btn-active { background: var(--gray-200); }
        
        /* ===== Table ===== */
        .overflow-x-auto { overflow-x: auto; }
        .table {
          width: 100%;
          border-collapse: collapse;
          background: var(--white);
        }
        .table th,
        .table td {
          padding: var(--space-3) var(--space-4);
          border-bottom: 1px solid var(--gray-200);
          font-size: var(--fs-md);
        }
        .table thead tr { background: var(--gray-50); }
        
        /* ===== Card ===== */
        .dashboard-card {
          background: var(--white);
          border-radius: var(--radius-lg);
          box-shadow: 0 10px 30px rgba(0,0,0,0.05);
          transition: transform 0.3s ease;
          margin-bottom: var(--space-6);
        }
        
        /* ===== Pagination ===== */
        .join {
          display: inline-flex;
          border-radius: var(--radius-sm);
          overflow: hidden;
        }
        .join-item {
          padding: var(--space-2) var(--space-3);
          border-right: 1px solid var(--gray-200);
          margin: 10px;
        }
        .join-item:last-child { border-right: none; }
        
        /* ===== تخصيص مودال التفاصيل ===== */
        dialog.modal {
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.5);
  padding: 0;
  border: none;
  width: 100vw;
  height: 100vh;
  max-width: none;
}

.modal-box {
  width: 96vw;
  height: 92vh;
  max-width: 1400px;
  max-height: 92vh;
  display: flex;
  flex-direction: column;
  border-radius: var(--radius-lg);
  padding: var(--space-5);
  background: var(--white);
  overflow: hidden;
}


.modal-box h3 {
  font-size: var(--fs-xl);
  border-bottom: 2px solid var(--gray-200);
  padding-bottom: var(--space-3);
  margin-bottom: var(--space-4);
}

#orderDetails {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-6);
  flex-grow: 1;
  overflow: auto;
  padding: var(--space-3);
}

/* القسم الأيسر - معلومات العميل */
.order-info-section {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-3);
  align-content: start;
}

.order-info-section h4 {
  font-weight: 600;
  color: var(--primary);
  grid-column: span 2;
  margin-top: var(--space-3);
}

.order-info-section p {
  background: var(--gray-50);
  padding: var(--space-2);
  border-radius: var(--radius-sm);
  margin: 0;
}

/* قسم تحديث الحالة */
.status-update-section {
  grid-column: span 2;
  border-top: 2px solid var(--gray-200);
  padding-top: var(--space-4);
}

/* قسم الصور */
.images-section {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.images-container {
  flex-grow: 1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: var(--space-3);
  overflow-y: auto;
  padding: var(--space-2);
}

.images-container img {
  width: 100%;
  height: 180px;
  object-fit: contain;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  background: white;
  padding: var(--space-1);
}


        
        /* ===== زر التحديث والإغلاق ===== */
        .modal-action .btn {
          padding: var(--space-2) var(--space-4);
          font-size: var(--fs-md);
        }
        
        /* ===== Badges ===== */
        .order-status {
          display: inline-block;
          padding: var(--space-1) var(--space-3);
          border-radius: 9999px;
          font-size: var(--fs-sm);
        }
        .status-pending     { background: #E3F2FD; color: #1976D2; }
        .status-in_progress { background: #FFF3E0; color: #EF6C00; }
        .status-completed   { background: #E8F5E9; color: #2E7D32; }
        </style>
        
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">إدارة الطلبات</h1>
            <div class="flex gap-4 mt-4">
                <div class="flex-1">
                    <input type="text" id="search" placeholder="ابحث بالاسم أو رقم الهاتف..." 
                           class="w-full input input-bordered">
                </div>
                <select id="statusFilter" class="select select-bordered">
                    <option value="">جميع الحالات</option>
                    <option value="pending">قيد الانتظار</option>
                    <option value="in_progress">قيد التنفيذ</option>
                    <option value="completed">مكتمل</option>
                </select>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="dashboard-card overflow-hidden">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-right">رقم الطلب</th>
                            <th class="text-right">العميل</th>
                            <th class="text-right">رقم الهاتف</th>
                            <th class="text-right">المحافظة</th>
                            <th class="text-right">تاريخ الطلب</th>
                            <th class="text-right">الحالة</th>
                            <th class="text-right">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-center p-4 bg-gray-50">
                <div class="join" id="pagination">
                    <!-- Dynamic pagination buttons -->
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <dialog id="orderModal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl">
            <h3 class="font-bold text-lg">تفاصيل الطلب</h3>
            <div class="py-4 grid grid-cols-1 md:grid-cols-2 gap-4" id="orderDetails">
                <!-- Dynamic content -->
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">إغلاق</button>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const itemsPerPage = 10;

        async function loadOrders(page = 1, search = '', status = '') {
            try {
                const response = await fetch(`/orders?page=${page}&limit=${itemsPerPage}&search=${search}&orderStatus=${status}`, {
  headers: {
    'Accept': 'application/json'
  }});                const data = await response.json();
                
                renderOrders(data.items);
                renderPagination(data.totalPages, page);
                currentPage = page;
                totalPages = data.totalPages;
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('ordersBody');
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>#${order.id}</td>
                    <td>${order.name}</td>
                    <td>${order.mobile}</td>
                    <td>${order.city}</td>
                    <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    <td>
                        <span class="order-status status-${order.orderStatus}">
                            ${getStatusText(order.orderStatus)}
                        </span>
                    </td>
                    <td>
                        <button onclick="showOrderDetails(${order.id})" class="btn btn-ghost btn-sm">
                            <i class="ph ph-eye"></i>
                            التفاصيل
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(totalPages, currentPage) {
            const pagination = document.getElementById('pagination');
            let buttons = '';
            
            for (let i = 1; i <= totalPages; i++) {
                buttons += `
                    <button class="join-item btn ${i === currentPage ? 'btn-active' : ''}" 
                            onclick="loadOrders(${i})">${i}</button>
                `;
            }
            
            pagination.innerHTML = buttons;
        }

  

        async function showOrderDetails(orderId) {
  try {
    const response = await fetch(`/orders/${orderId}`);
    const order = await response.json();

    const imagesHTML = order.images.map(img => {
      const isEncoded = /%[0-9A-Fa-f]{2}/.test(img);
      let finalSrc = isEncoded ? decodeURIComponent(img) : encodeURI(img);
      finalSrc = finalSrc.replace(/%25([0-9A-Fa-f]{2})/g, '%$1');
      return `
        <div class="image-item">
          <img src="${finalSrc}" 
               alt="صورة الطلب"
               onerror="this.src='/placeholder-image.png'">
        </div>
      `;
    }).join('');

    document.getElementById('orderDetails').innerHTML = `
      <div class="order-info-section">
        <h4>معلومات العميل</h4>
        <div class="info-group">
          <label>الاسم الكامل:</label>
          <p>${order.name}</p>
        </div>
        <div class="info-group">
          <label>رقم الجوال:</label>
          <p>${order.mobile}</p>
        </div>
        <div class="info-group">
          <label>المحافظة:</label>
          <p>${order.city}</p>
        </div>
        <div class="info-group">
          <label>النقطة الدالة:</label>
          <p>${order.nearestPoint}</p>
        </div>
        <div class="info-group">
          <label>ملاحظات:</label>
          <p>${order.notes || 'لا توجد ملاحظات'}</p>
        </div>
        
        <div class="status-update-section">
          <h4>حالة الطلب</h4>
          <div class="current-status">
            <span class="order-status status-${order.orderStatus}">
              ${getStatusText(order.orderStatus)}
            </span>
            
          </div>
          <br>
          <div class="update-form">
            <select id="statusUpdate" class="input">
              <option value="pending" ${order.orderStatus === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
              <option value="in_progress" ${order.orderStatus === 'in_progress' ? 'selected' : ''}>قيد التنفيذ</option>
              <option value="completed" ${order.orderStatus === 'completed' ? 'selected' : ''}>مكتمل</option>
            </select>
            <button onclick="updateStatus(${order.id})" class="btn btn-primary mt-3">
              <i class="ph ph-arrows-clockwise"></i>
              تحديث الحالة
            </button>
          </div>
        </div>
      </div>

      <div class="images-section">
        <h4>الصور المرفوعة (${order.images.length})</h4>
        <div class="images-container">
          ${imagesHTML}
        </div>
      </div>
    `;

    document.getElementById('orderModal').showModal();
  } catch (error) {
    console.error('Error fetching order details:', error);
  }
}

        async function updateStatus(orderId) {
            const newStatus = document.getElementById('statusUpdate').value;
            
            try {
                const response = await fetch(`/orders/orderstatus/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderStatus: newStatus })
                });

                if (response.ok) {
                    loadOrders(currentPage);
                    document.getElementById('orderModal').close();
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                pending: 'قيد الانتظار',
                in_progress: 'قيد التنفيذ',
                completed: 'مكتمل'
            };
            return statusMap[status] || 'غير معروف';
        }

        // Event Listeners
        document.getElementById('search').addEventListener('input', (e) => {
            loadOrders(1, e.target.value, document.getElementById('statusFilter').value);
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            loadOrders(1, document.getElementById('search').value, e.target.value);
        });

        // Initial Load
        loadOrders();

    </script>
</body>
</html>